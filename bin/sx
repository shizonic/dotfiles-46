#!/bin/sh --

# This fantastic script is originally from https://raw.githubusercontent.com/Earnestly/sx/master/sx

# This version makes the following changes:

# Use ~/.xinitrc instead of ~/.config/sx/sxrc
# add -quiet
# add -nolisten tcp
# add -nolisten local
# remove -keeptty
# set a faster default keyboard repeat/rate interval.

# sx - start an xserver

# requires xauth Xorg

cleanup() {
    if [ "$pid" ] && kill -0 "$pid" 2> /dev/null; then
        kill -s TERM "$pid"
        wait "$pid"
        r=$?
    fi

    if ! stty "$stty"; then
        stty sane
    fi

    xauth remove :"$tty"
    exit "${r:-$?}"
}

stty=$(stty -g)
tty=$(ps -o tty= -p $$)
tty=${tty#tty}

datadir=${XDG_DATA_HOME:-$HOME/.local/share}/sx

mkdir -p "$datadir"

export XAUTHORITY=${XAUTHORITY:-$datadir/xauthority}
touch "$XAUTHORITY"

trap 'cleanup' EXIT
xauth add :"$tty" MIT-MAGIC-COOKIE-1 "$(od -An -N16 -tx /dev/urandom | tr -d ' ')"

# Xorg will check if its SIGUSR1 disposition is SIG_IGN and use this state to
# reply back to the parent process with its own SIGUSR1 as an indication it is
# ready to accept connections.
# Taking advantage of this feature allows us to launch our client directly
# from a SIGUSR1 handler and avoid the need to poll for server readiness.
trap 'DISPLAY=:$tty ~/.xinitrc' USR1
(trap '' USR1 && exec Xorg -nolisten tcp -nolisten local :"$tty" -quiet vt"$tty" -noreset -auth "$XAUTHORITY" -arinterval "30" -ardelay "175") & pid=$!
wait "$pid"
